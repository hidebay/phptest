<?php
/**
 * OXID module: wn_adminrights
 *
 * @version 1.2.0
 * @author Sascha Mahnecke
 * @copyright 2012-2014 by Wendnet
 */
class wnar_user_rights extends oxAdminView{public function render(){parent::render();$ob56eccfb8=$this->ob383446c4();if($ob56eccfb8!="-1"&&isset($ob56eccfb8)){if($ob56eccfb8!='oxdefaultadmin'&&$ob56eccfb8==$this->getUser()->getId())$this->_aViewData['noAccess']=true;$obb01e62e9=oxNew('oxuser');$obb01e62e9->load($ob56eccfb8);if(($obf78c10d4=$obb01e62e9->oxuser__wnrestrict->value)===null)self::onActivate();$obed63d5f5=array();if($obf78c10d4=$obb01e62e9->oxuser__wnrestrict->value){$obd9af52f6=explode(',',$obf78c10d4);foreach($obd9af52f6 as$obc22e64f0)$obed63d5f5[$obc22e64f0]=true;}$this->_aViewData['menustructure']=$this->getNavigation()->getDomXml(true)->documentElement->childNodes;$this->_aViewData['edit']=$obb01e62e9;$this->_aViewData['restrict']=$obed63d5f5;$this->_aViewData['chknoeditadmin']=!empty($obed63d5f5['noeditadmin']);$this->_aViewData['chknoforeignart']=!empty($obed63d5f5['noforeignart']);$this->_aViewData['chknoservicearea']=!empty($obed63d5f5['noservicearea']);$this->_aViewData['chknodeltmp']=!empty($obed63d5f5['nodeltmp']);}if(!$this->_allowAdminEdit($ob56eccfb8))$this->_aViewData['readonly']=true;return"wnar_user_rights.tpl";}public function save(){parent::save();$ob56eccfb8=$this->ob383446c4();if(!$this->_allowAdminEdit($ob56eccfb8))return false;$obf02cec44=oxConfig::getParameter('editval');$obf78c10d4=trim($obf02cec44['oxuser__wnrestrict']," ,\t\n\r");$obed63d5f5=array();$obb01e62e9=oxNew("oxuser");if($ob56eccfb8!="-1"){$obb01e62e9->load($ob56eccfb8);}else{$obf02cec44['oxuser__oxid']=null;}$obf02cec44['oxuser__oxactive']=$obb01e62e9->oxuser__oxactive->value;if(!$obf78c10d4){if(!is_array($ob2094d939=oxConfig::getParameter('restrict')))$ob2094d939=array();}else$ob2094d939=explode(',',$obf78c10d4);foreach($ob2094d939 as$ob1f801901){$ob1f801901=trim($ob1f801901);if(preg_match("/^[\w ]+$/",$ob1f801901))$obed63d5f5[]=$ob1f801901;}$obf02cec44['oxuser__wnrestrict']=implode(',',array_unique($obed63d5f5));$obb01e62e9->assign($obf02cec44);if($obb01e62e9->save())$this->_aViewData['savedone']=true;}protected function ob383446c4(){if(version_compare(oxConfig::getInstance()->getVersion(),'4.5.0','>='))return$this->getEditObjectId();if(null===($ob3a942e4a=$this->_sEditObjectId)){if(null===($ob3a942e4a=oxConfig::getParameter("oxid"))){$ob3a942e4a=oxSession::getVar("saved_oxid");}}return$ob3a942e4a;}static function onActivate(){$obe95a4d65=oxDb::getDb();$ob96f7484c=false;$ob812ca079=0;try{$obe95a4d65->execute("SELECT wnrestrict FROM oxuser LIMIT 1");}catch(Exception$ob31ef059e){}if((int)$obe95a4d65->errorNo()==1054){try{$obe95a4d65->execute("ALTER TABLE oxuser ADD WNRESTRICT TEXT CHARACTER SET latin1 COLLATE latin1_general_ci NOT NULL");}catch(Exception$ob31ef059e){}if($obe95a4d65->errorNo())$ob96f7484c=true;}else$ob812ca079++;try{$obe95a4d65->execute("SELECT wnuserid FROM oxarticles LIMIT 1");}catch(Exception$ob31ef059e){}if((int)$obe95a4d65->errorNo()==1054){try{$obe95a4d65->execute("ALTER TABLE oxarticles ADD WNUSERID CHAR(32) CHARACTER SET latin1 COLLATE latin1_general_ci DEFAULT '' NOT NULL");}catch(Exception$ob31ef059e){}if($obe95a4d65->errorNo())$ob96f7484c=true;}else$ob812ca079++;if($ob812ca079==2)return;$obb093ae7d=class_exists('oxRegistry')?oxRegistry::getConfig():oxConfig::getInstance();$ob7a11c644=class_exists('oxRegistry')?oxRegistry::getLang():oxLang::getInstance();$oba56e5ac1=$ob7a11c644->getTplLanguage();if($ob96f7484c){$ob37d4424b=$ob7a11c644->translateString('USER_RIGHTS_DB_SETUP_ERROR',$oba56e5ac1).'<br>'.$obe800f1e9.'<hr>('.$obe95a4d65->errorNo().') '.$obe95a4d65->errorMsg();$ob72ecf335=class_exists('oxRegistry')?oxRegistry::getUtils():oxUtils::getInstance();$ob72ecf335->showMessageAndExit($ob37d4424b);}$ob1d88f7a3=$obb093ae7d->getConfigParam('sCompileDir');if($ob2581733c=glob($ob1d88f7a3.'oxpec_fieldnames_oxuser_allviews*.txt'))foreach($ob2581733c as$obd8155113)@unlink($obd8155113);if($ob2581733c=glob($ob1d88f7a3.'oxpec_oxuser_allfields_*.txt'))foreach($ob2581733c as$obd8155113)@unlink($obd8155113);if($ob2581733c=glob($ob1d88f7a3.'oxpec_fieldnames_oxarticles_details*.txt'))foreach($ob2581733c as$obd8155113)@unlink($obd8155113);if($ob2581733c=glob($ob1d88f7a3.'oxpec_oxarticles_allfields_*.txt'))foreach($ob2581733c as$obd8155113)@unlink($obd8155113);$ob7aac9a05=oxNew('oxDbMetaDataHandler');if(!$ob7aac9a05->updateViews(array('oxarticles'))){$ob37d4424b=$ob7a11c644->translateString('USER_RIGHTS_DB_SETUP_ERROR',$oba56e5ac1).'<br>(updateViews)';$ob72ecf335=class_exists('oxRegistry')?oxRegistry::getUtils():oxUtils::getInstance();$ob72ecf335->showMessageAndExit($ob37d4424b);}$ob3e8f6fd4=$ob7a11c644->translateString('USER_RIGHTS_DB_SETUP_DONE',$oba56e5ac1);echo'<script type="text/javascript">alert("'.$ob3e8f6fd4.'");</script>';}}