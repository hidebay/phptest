<?php
/**
 * OXID module: wn_adminrights
 *
 * @version 1.0.0
 * @author Sascha Mahnecke
 * @copyright 2012 by Wendnet
 */
class wn_user_rights extends oxAdminDetails{const ob31c4fe71='wn_adminrights';public function render(){parent::render();$ob6ace050f=$this->ob38104b29();if($ob6ace050f!="-1"&&isset($ob6ace050f)){$obab60702e=oxNew("oxuser");$obab60702e->load($ob6ace050f);$this->_aViewData["menustructure"]=$this->getNavigation()->getDomXml(true)->documentElement->childNodes;$this->_aViewData["edit"]=$obab60702e;if(($oba69caa77=$obab60702e->oxuser__wnrestrict->value)===null)$this->_installSql();$oba56d7763=array();if($oba69caa77){$ob91353855=explode(',',$oba69caa77);foreach($ob91353855 as$ob11a88547)$oba56d7763[$ob11a88547]=true;}$this->_aViewData["restrict"]=$oba56d7763;$this->_aViewData["chknoeditadmin"]=!empty($oba56d7763['noeditadmin']);$this->_aViewData["disablechk"]=($ob6ace050f==$this->getUser()->getId());}if(!$this->_allowAdminEdit($ob6ace050f))$this->_aViewData['readonly']=true;return"wn_user_rights.tpl";}public function save(){parent::save();$ob6ace050f=$this->ob38104b29();if(!$this->_allowAdminEdit($ob6ace050f))return false;$oba6317709=oxConfig::getParameter("editval");$oba6317709['oxuser__wnrestrict']=trim($oba6317709['oxuser__wnrestrict']," ,\t\n\r");$obab60702e=oxNew("oxuser");if($ob6ace050f!="-1"){$obab60702e->load($ob6ace050f);}else{$oba6317709['oxuser__oxid']=null;}$oba6317709['oxuser__oxactive']=$obab60702e->oxuser__oxactive->value;if(!$oba6317709['oxuser__wnrestrict']){if(!is_array($oba56d7763=oxConfig::getParameter("restrict")))$oba56d7763=array();$oba6317709['oxuser__wnrestrict']=implode(',',$oba56d7763);}if($ob6ace050f==$this->getUser()->getId()&&strpos($obab60702e->oxuser__wnrestrict->value,'noeditadmin')!==false&&strpos($oba6317709['oxuser__wnrestrict'],'noeditadmin')===false){$oba6317709['oxuser__wnrestrict'].=$oba6317709['oxuser__wnrestrict']?',':'';$oba6317709['oxuser__wnrestrict'].='noeditadmin';}$obab60702e->assign($oba6317709);if($obab60702e->save())$this->_aViewData['savedone']=true;}protected function ob38104b29(){if(version_compare(oxConfig::getInstance()->getVersion(),'4.5.0')>=0){return$this->getEditObjectId();}else{if(null===($ob41a59b9e=oxConfig::getParameter("oxid"))){$ob41a59b9e=oxSession::getVar("saved_oxid");}return$ob41a59b9e;}}protected function _installSql(){$ob188aa5d0=oxDb::getDb();$ob44d36d45=$this->getConfig();$obe9b8e008=$ob44d36d45->getConfigParam('sShopDir').'modules/'.self::ob31c4fe71.'/sql/install.sql';if(!$obcdf9ea58=trim(@file_get_contents($obe9b8e008),';')){$ob087213a3=oxLang::getInstance();$ob3fdffc3e=$ob087213a3->getTplLanguage();$ob856e13bf=$ob087213a3->translateString('USER_RIGHTS_DB_LOAD_ERROR',$ob3fdffc3e).'<br>'.$obe9b8e008;oxUtils::getinstance()->showMessageAndExit($ob856e13bf);}$ob208fbbd8=explode(';',$obcdf9ea58);foreach($ob208fbbd8 as$ob5dd8f085){$obab1598e6=$ob188aa5d0->execute($ob5dd8f085);if($ob188aa5d0->errorNo()){$ob087213a3=oxLang::getInstance();$ob3fdffc3e=$ob087213a3->getTplLanguage();$ob856e13bf=$ob087213a3->translateString('USER_RIGHTS_DB_SETUP_ERROR',$ob3fdffc3e).'<br>'.$ob5dd8f085.'<hr>('.$ob188aa5d0->errorNo().') '.$ob188aa5d0->errorMsg();oxUtils::getinstance()->showMessageAndExit($ob856e13bf);}}@unlink(getShopBasePath().'tmp/oxpec_fieldnames_oxuser_allviews_i18n.txt');foreach(glob(getShopBasePath().'tmp/oxpec_oxuser_allfields_*.txt')as$obe9b8e008)@unlink($obe9b8e008);$this->_aViewData['setupdone']=true;}}